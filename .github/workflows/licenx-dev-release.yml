name: licenx-dev-release

on:
  workflow_dispatch:
    inputs:
      licenx-environment:
        description: CMake environment passed to the LicenX generator
        default: dev
        required: false
      licenx-branch:
        description: LicenX submodule branch or ref to build
        default: main
        required: false
      dockerfile-relative-path:
        description: Optional Dockerfile path relative to repository root
        default: ergox/licenx/docker/admin-cli-server/Dockerfile
        required: false
      docker-image-tag:
        description: Container tag to publish alongside latest
        default: latest
        required: false

permissions:
  contents: read
  id-token: write
  packages: write

env:
  LICENX_SUBMODULE_PATH: ergox/licenx
  LICENX_SOURCE_DIR: ergox/licenx
  LICENX_BUILD_DIR: ergox/licenx/build
  LICENX_BUILD_CONFIG: Release
  LICENX_ARTIFACT_ROOT: ergox/licenx/artifacts
  LICENX_ENVIRONMENT_INPUT: ${{ github.event.inputs.licenx-environment || 'dev' }}

jobs:
  build-linux:
    name: Build + Test (Linux)
    runs-on: ubuntu-latest
    env:
      CMAKE_GENERATOR: Ninja
      CMAKE_BUILD_TYPE: Release
      CMAKE_MULTICONFIG: 'false'
      ARTIFACT_PLATFORM_SUFFIX: linux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Prepare LicenX workspace
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $moduleDir = [System.IO.Path]::Combine($Env:GITHUB_WORKSPACE, '.git/modules', $Env:LICENX_SUBMODULE_PATH)
          if (Test-Path $moduleDir) {
            Remove-Item $moduleDir -Recurse -Force
          }
          if (Test-Path $Env:LICENX_SUBMODULE_PATH) {
            Remove-Item $Env:LICENX_SUBMODULE_PATH -Recurse -Force
          }

      - name: Checkout LicenX source
        uses: actions/checkout@v4
        with:
          repository: ergosumx/licenx
          ref: ${{ github.event.inputs.licenx-branch || 'main' }}
          path: ${{ env.LICENX_SUBMODULE_PATH }}
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.ERGOX_SUBMODULE_TOKEN }}

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Setup vcpkg
        id: run-vcpkg-linux
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '74e6536215718009aae747d86d84b78376bf9e09'
          vcpkgDirectory: ${{ format('{0}/vcpkg', env.LICENX_SOURCE_DIR) }}
          runVcpkgInstall: true

      - name: Configure vcpkg environment
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${VCPKG_ROOT:-}" ]; then
            echo "VCPKG_ROOT is not defined after run-vcpkg" >&2
            exit 1
          fi
          echo "CMAKE_TOOLCHAIN_FILE=${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" >> "$GITHUB_ENV"
          echo "VCPKG_DEFAULT_TRIPLET=x64-linux" >> "$GITHUB_ENV"
          echo "VCPKG_DEFAULT_HOST_TRIPLET=x64-linux" >> "$GITHUB_ENV"
          echo "VCPKG_TARGET_TRIPLET=x64-linux" >> "$GITHUB_ENV"
          echo "VCPKG_DISABLE_METRICS=1" >> "$GITHUB_ENV"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Configure LicenX build
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $cmakeArgs = @(
            '-S', $Env:LICENX_SOURCE_DIR,
            '-B', $Env:LICENX_BUILD_DIR,
            '-G', $Env:CMAKE_GENERATOR,
            "-DLICENX_ENVIRONMENT=$Env:LICENX_ENVIRONMENT_INPUT",
            '-DLICENX_BUILD_TESTS=ON'
          )
          if ($Env:CMAKE_MULTICONFIG -ne 'true') {
            $cmakeArgs += "-DCMAKE_BUILD_TYPE=$Env:CMAKE_BUILD_TYPE"
          }
          if ($Env:CMAKE_GENERATOR_PLATFORM) {
            $cmakeArgs += '-A'
            $cmakeArgs += $Env:CMAKE_GENERATOR_PLATFORM
          }
          if ($Env:CMAKE_TOOLCHAIN_FILE) {
            $cmakeArgs += "-DCMAKE_TOOLCHAIN_FILE=$Env:CMAKE_TOOLCHAIN_FILE"
          }
          if ($Env:CMAKE_PREFIX_PATH) {
            $cmakeArgs += "-DCMAKE_PREFIX_PATH=$Env:CMAKE_PREFIX_PATH"
          }
          cmake @cmakeArgs

      - name: Build LicenX artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $args = @('--build', $Env:LICENX_BUILD_DIR)
          if ($multiConfig) { $args += @('--config', $Env:LICENX_BUILD_CONFIG) }
          cmake @args

      - name: Run unit tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $ctestArgs = @('--test-dir', $Env:LICENX_BUILD_DIR, '--output-on-failure')
          if ($multiConfig) { $ctestArgs += @('--config', $Env:LICENX_BUILD_CONFIG) }
          ctest @ctestArgs

      - name: Package release artifacts
        id: package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $workspace = $Env:GITHUB_WORKSPACE
          $buildDir = Join-Path $workspace $Env:LICENX_BUILD_DIR
          $artifactsRoot = Join-Path $workspace $Env:LICENX_ARTIFACT_ROOT
          $publishDir = Join-Path $artifactsRoot 'publish'
          $cliDir = Join-Path $artifactsRoot 'admin-cli'
          $sdkDir = Join-Path $artifactsRoot 'sdk'
          $sdkLibDir = Join-Path $sdkDir 'lib'
          $sdkIncludeDir = Join-Path $sdkDir 'include'

          foreach ($dir in @($artifactsRoot, $publishDir, $cliDir, $sdkDir, $sdkLibDir, $sdkIncludeDir)) {
            if (-not (Test-Path $dir)) {
              New-Item -ItemType Directory -Path $dir | Out-Null
            }
          }

          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $outputDir = if ($multiConfig) { Join-Path $buildDir $Env:LICENX_BUILD_CONFIG } else { $buildDir }

          $cliCandidates = @(
            Join-Path $outputDir 'licenx_admin_cli.exe',
            Join-Path $outputDir 'licenx_admin_cli',
            Join-Path $buildDir 'licenx_admin_cli.exe',
            Join-Path $buildDir 'licenx_admin_cli'
          )

          $cliPath = $null
          foreach ($candidate in $cliCandidates) {
            if (Test-Path $candidate) {
              $cliPath = $candidate
              break
            }
          }

          if (-not $cliPath) {
            throw "Expected CLI artifact not found. Checked: $($cliCandidates -join ', ')"
          }

          Copy-Item $cliPath $cliDir -Force

          $libraryPatterns = @('licenx*.lib','licenx*.dll','licenx*.exp','licenx*.pdb','liblicenx*.a','liblicenx*.so','liblicenx*.dylib')
          $libraries = @()
          foreach ($pattern in $libraryPatterns) {
            $libraries += Get-ChildItem -Path $outputDir -Recurse -File -Filter $pattern -ErrorAction SilentlyContinue
          }
          $libraries = $libraries | Sort-Object -Property FullName -Unique
          if ($libraries.Count -eq 0) {
            throw "No LicenX library artifacts matching expected patterns were found in $outputDir"
          }
          foreach ($lib in $libraries) {
            Copy-Item $lib.FullName $sdkLibDir -Force
          }

          $includeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'include')
          if (-not (Test-Path $includeSource)) {
            throw "Header directory not found at $includeSource"
          }
          Copy-Item (Join-Path $includeSource '*') $sdkIncludeDir -Recurse -Force

          $readmeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'README.md')
          if (Test-Path $readmeSource) {
            Copy-Item $readmeSource $sdkDir -Force
          }

          $platform = $Env:ARTIFACT_PLATFORM_SUFFIX
          $cliZip = Join-Path $publishDir "licenx-admin-cli-$platform.zip"
          $sdkZip = Join-Path $publishDir "licenx-sdk-$platform.zip"

          if (Test-Path $cliZip) { Remove-Item $cliZip -Force }
          if (Test-Path $sdkZip) { Remove-Item $sdkZip -Force }

          Compress-Archive -Path (Join-Path $cliDir '*') -DestinationPath $cliZip -Force
          Compress-Archive -Path (Join-Path $sdkDir '*') -DestinationPath $sdkZip -Force

          "publish-dir=$publishDir" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: licenx-linux
          path: ${{ steps.package.outputs.publish-dir }}
          if-no-files-found: error

  build-macos:
    name: Build + Test (macOS)
    runs-on: macos-latest
    env:
      CMAKE_GENERATOR: Ninja
      CMAKE_BUILD_TYPE: Release
      CMAKE_MULTICONFIG: 'false'
      ARTIFACT_PLATFORM_SUFFIX: macos
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Prepare LicenX workspace
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $moduleDir = [System.IO.Path]::Combine($Env:GITHUB_WORKSPACE, '.git/modules', $Env:LICENX_SUBMODULE_PATH)
          if (Test-Path $moduleDir) {
            Remove-Item $moduleDir -Recurse -Force
          }
          if (Test-Path $Env:LICENX_SUBMODULE_PATH) {
            Remove-Item $Env:LICENX_SUBMODULE_PATH -Recurse -Force
          }

      - name: Checkout LicenX source
        uses: actions/checkout@v4
        with:
          repository: ergosumx/licenx
          ref: ${{ github.event.inputs.licenx-branch || 'main' }}
          path: ${{ env.LICENX_SUBMODULE_PATH }}
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.ERGOX_SUBMODULE_TOKEN }}

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          if ! brew list ninja >/dev/null 2>&1; then
            brew install ninja
          fi

      - name: Setup vcpkg
        id: run-vcpkg-macos
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '74e6536215718009aae747d86d84b78376bf9e09'
          vcpkgDirectory: ${{ format('{0}/vcpkg', env.LICENX_SOURCE_DIR) }}
          runVcpkgInstall: true

      - name: Configure vcpkg environment
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${VCPKG_ROOT:-}" ]; then
            echo "VCPKG_ROOT is not defined after run-vcpkg" >&2
            exit 1
          fi
          echo "CMAKE_TOOLCHAIN_FILE=${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" >> "$GITHUB_ENV"
          echo "VCPKG_DEFAULT_TRIPLET=x64-osx" >> "$GITHUB_ENV"
          echo "VCPKG_DEFAULT_HOST_TRIPLET=x64-osx" >> "$GITHUB_ENV"
          echo "VCPKG_TARGET_TRIPLET=x64-osx" >> "$GITHUB_ENV"
          echo "VCPKG_DISABLE_METRICS=1" >> "$GITHUB_ENV"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Configure LicenX build
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $cmakeArgs = @(
            '-S', $Env:LICENX_SOURCE_DIR,
            '-B', $Env:LICENX_BUILD_DIR,
            '-G', $Env:CMAKE_GENERATOR,
            "-DLICENX_ENVIRONMENT=$Env:LICENX_ENVIRONMENT_INPUT",
            '-DLICENX_BUILD_TESTS=ON'
          )
          if ($Env:CMAKE_MULTICONFIG -ne 'true') {
            $cmakeArgs += "-DCMAKE_BUILD_TYPE=$Env:CMAKE_BUILD_TYPE"
          }
          if ($Env:CMAKE_GENERATOR_PLATFORM) {
            $cmakeArgs += '-A'
            $cmakeArgs += $Env:CMAKE_GENERATOR_PLATFORM
          }
          if ($Env:CMAKE_TOOLCHAIN_FILE) {
            $cmakeArgs += "-DCMAKE_TOOLCHAIN_FILE=$Env:CMAKE_TOOLCHAIN_FILE"
          }
          if ($Env:CMAKE_PREFIX_PATH) {
            $cmakeArgs += "-DCMAKE_PREFIX_PATH=$Env:CMAKE_PREFIX_PATH"
          }
          cmake @cmakeArgs

      - name: Build LicenX artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $args = @('--build', $Env:LICENX_BUILD_DIR)
          if ($multiConfig) { $args += @('--config', $Env:LICENX_BUILD_CONFIG) }
          cmake @args

      - name: Run unit tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $ctestArgs = @('--test-dir', $Env:LICENX_BUILD_DIR, '--output-on-failure')
          if ($multiConfig) { $ctestArgs += @('--config', $Env:LICENX_BUILD_CONFIG) }
          ctest @ctestArgs

      - name: Package release artifacts
        id: package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $workspace = $Env:GITHUB_WORKSPACE
          $buildDir = Join-Path $workspace $Env:LICENX_BUILD_DIR
          $artifactsRoot = Join-Path $workspace $Env:LICENX_ARTIFACT_ROOT
          $publishDir = Join-Path $artifactsRoot 'publish'
          $cliDir = Join-Path $artifactsRoot 'admin-cli'
          $sdkDir = Join-Path $artifactsRoot 'sdk'
          $sdkLibDir = Join-Path $sdkDir 'lib'
          $sdkIncludeDir = Join-Path $sdkDir 'include'

          foreach ($dir in @($artifactsRoot, $publishDir, $cliDir, $sdkDir, $sdkLibDir, $sdkIncludeDir)) {
            if (-not (Test-Path $dir)) {
              New-Item -ItemType Directory -Path $dir | Out-Null
            }
          }

          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $outputDir = if ($multiConfig) { Join-Path $buildDir $Env:LICENX_BUILD_CONFIG } else { $buildDir }

          $cliCandidates = @(
            Join-Path $outputDir 'licenx_admin_cli.exe',
            Join-Path $outputDir 'licenx_admin_cli',
            Join-Path $buildDir 'licenx_admin_cli.exe',
            Join-Path $buildDir 'licenx_admin_cli'
          )

          $cliPath = $null
          foreach ($candidate in $cliCandidates) {
            if (Test-Path $candidate) {
              $cliPath = $candidate
              break
            }
          }

          if (-not $cliPath) {
            throw "Expected CLI artifact not found. Checked: $($cliCandidates -join ', ')"
          }

          Copy-Item $cliPath $cliDir -Force

          $libraryPatterns = @('licenx*.lib','licenx*.dll','licenx*.exp','licenx*.pdb','liblicenx*.a','liblicenx*.so','liblicenx*.dylib')
          $libraries = @()
          foreach ($pattern in $libraryPatterns) {
            $libraries += Get-ChildItem -Path $outputDir -Recurse -File -Filter $pattern -ErrorAction SilentlyContinue
          }
          $libraries = $libraries | Sort-Object -Property FullName -Unique
          if ($libraries.Count -eq 0) {
            throw "No LicenX library artifacts matching expected patterns were found in $outputDir"
          }
          foreach ($lib in $libraries) {
            Copy-Item $lib.FullName $sdkLibDir -Force
          }

          $includeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'include')
          if (-not (Test-Path $includeSource)) {
            throw "Header directory not found at $includeSource"
          }
          Copy-Item (Join-Path $includeSource '*') $sdkIncludeDir -Recurse -Force

          $readmeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'README.md')
          if (Test-Path $readmeSource) {
            Copy-Item $readmeSource $sdkDir -Force
          }

          $platform = $Env:ARTIFACT_PLATFORM_SUFFIX
          $cliZip = Join-Path $publishDir "licenx-admin-cli-$platform.zip"
          $sdkZip = Join-Path $publishDir "licenx-sdk-$platform.zip"

          if (Test-Path $cliZip) { Remove-Item $cliZip -Force }
          if (Test-Path $sdkZip) { Remove-Item $sdkZip -Force }

          Compress-Archive -Path (Join-Path $cliDir '*') -DestinationPath $cliZip -Force
          Compress-Archive -Path (Join-Path $sdkDir '*') -DestinationPath $sdkZip -Force

          "publish-dir=$publishDir" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: licenx-macos
          path: ${{ steps.package.outputs.publish-dir }}
          if-no-files-found: error

  build-windows:
    name: Build + Test (Windows)
    runs-on: windows-latest
    env:
      CMAKE_GENERATOR: "Visual Studio 17 2022"
      CMAKE_GENERATOR_PLATFORM: x64
      CMAKE_BUILD_TYPE: Release
      CMAKE_MULTICONFIG: 'true'
      ARTIFACT_PLATFORM_SUFFIX: windows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Prepare LicenX workspace
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $moduleDir = [System.IO.Path]::Combine($Env:GITHUB_WORKSPACE, '.git/modules', $Env:LICENX_SUBMODULE_PATH)
          if (Test-Path $moduleDir) {
            Remove-Item $moduleDir -Recurse -Force
          }
          if (Test-Path $Env:LICENX_SUBMODULE_PATH) {
            Remove-Item $Env:LICENX_SUBMODULE_PATH -Recurse -Force
          }

      - name: Checkout LicenX source
        uses: actions/checkout@v4
        with:
          repository: ergosumx/licenx
          ref: ${{ github.event.inputs.licenx-branch || 'main' }}
          path: ${{ env.LICENX_SUBMODULE_PATH }}
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.ERGOX_SUBMODULE_TOKEN }}

      - name: Setup vcpkg
        id: run-vcpkg-windows
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '74e6536215718009aae747d86d84b78376bf9e09'
          vcpkgDirectory: ${{ format('{0}/vcpkg', env.LICENX_SOURCE_DIR) }}
          runVcpkgInstall: true

      - name: Configure vcpkg environment
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not $Env:VCPKG_ROOT) {
            Write-Error 'VCPKG_ROOT is not defined after run-vcpkg.'
          }

          $toolchain = Join-Path $Env:VCPKG_ROOT 'scripts/buildsystems/vcpkg.cmake'
          "CMAKE_TOOLCHAIN_FILE=$toolchain" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          'VCPKG_DEFAULT_TRIPLET=x64-windows' | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          'VCPKG_DEFAULT_HOST_TRIPLET=x64-windows' | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          'VCPKG_TARGET_TRIPLET=x64-windows' | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          'VCPKG_DISABLE_METRICS=1' | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Configure LicenX build
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $cmakeArgs = @(
            '-S', $Env:LICENX_SOURCE_DIR,
            '-B', $Env:LICENX_BUILD_DIR,
            '-G', $Env:CMAKE_GENERATOR,
            "-DLICENX_ENVIRONMENT=$Env:LICENX_ENVIRONMENT_INPUT",
            '-DLICENX_BUILD_TESTS=ON'
          )
          if ($Env:CMAKE_MULTICONFIG -ne 'true') {
            $cmakeArgs += "-DCMAKE_BUILD_TYPE=$Env:CMAKE_BUILD_TYPE"
          }
          if ($Env:CMAKE_GENERATOR_PLATFORM) {
            $cmakeArgs += '-A'
            $cmakeArgs += $Env:CMAKE_GENERATOR_PLATFORM
          }
          if ($Env:CMAKE_TOOLCHAIN_FILE) {
            $cmakeArgs += "-DCMAKE_TOOLCHAIN_FILE=$Env:CMAKE_TOOLCHAIN_FILE"
          }
          if ($Env:CMAKE_PREFIX_PATH) {
            $cmakeArgs += "-DCMAKE_PREFIX_PATH=$Env:CMAKE_PREFIX_PATH"
          }
          cmake @cmakeArgs

      - name: Build LicenX artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $args = @('--build', $Env:LICENX_BUILD_DIR)
          if ($multiConfig) { $args += @('--config', $Env:LICENX_BUILD_CONFIG) }
          cmake @args

      - name: Run unit tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $ctestArgs = @('--test-dir', $Env:LICENX_BUILD_DIR, '--output-on-failure')
          if ($multiConfig) { $ctestArgs += @('--config', $Env:LICENX_BUILD_CONFIG) }
          ctest @ctestArgs

      - name: Package release artifacts
        id: package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $workspace = $Env:GITHUB_WORKSPACE
          $buildDir = Join-Path $workspace $Env:LICENX_BUILD_DIR
          $artifactsRoot = Join-Path $workspace $Env:LICENX_ARTIFACT_ROOT
          $publishDir = Join-Path $artifactsRoot 'publish'
          $cliDir = Join-Path $artifactsRoot 'admin-cli'
          $sdkDir = Join-Path $artifactsRoot 'sdk'
          $sdkLibDir = Join-Path $sdkDir 'lib'
          $sdkIncludeDir = Join-Path $sdkDir 'include'

          foreach ($dir in @($artifactsRoot, $publishDir, $cliDir, $sdkDir, $sdkLibDir, $sdkIncludeDir)) {
            if (-not (Test-Path $dir)) {
              New-Item -ItemType Directory -Path $dir | Out-Null
            }
          }

          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $outputDir = if ($multiConfig) { Join-Path $buildDir $Env:LICENX_BUILD_CONFIG } else { $buildDir }

          $cliCandidates = @(
            Join-Path $outputDir 'licenx_admin_cli.exe',
            Join-Path $outputDir 'licenx_admin_cli',
            Join-Path $buildDir 'licenx_admin_cli.exe',
            Join-Path $buildDir 'licenx_admin_cli'
          )

          $cliPath = $null
          foreach ($candidate in $cliCandidates) {
            if (Test-Path $candidate) {
              $cliPath = $candidate
              break
            }
          }

          if (-not $cliPath) {
            throw "Expected CLI artifact not found. Checked: $($cliCandidates -join ', ')"
          }

          Copy-Item $cliPath $cliDir -Force

          $libraryPatterns = @('licenx*.lib','licenx*.dll','licenx*.exp','licenx*.pdb','liblicenx*.a','liblicenx*.so','liblicenx*.dylib')
          $libraries = @()
          foreach ($pattern in $libraryPatterns) {
            $libraries += Get-ChildItem -Path $outputDir -Recurse -File -Filter $pattern -ErrorAction SilentlyContinue
          }
          $libraries = $libraries | Sort-Object -Property FullName -Unique
          if ($libraries.Count -eq 0) {
            throw "No LicenX library artifacts matching expected patterns were found in $outputDir"
          }
          foreach ($lib in $libraries) {
            Copy-Item $lib.FullName $sdkLibDir -Force
          }

          $includeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'include')
          if (-not (Test-Path $includeSource)) {
            throw "Header directory not found at $includeSource"
          }
          Copy-Item (Join-Path $includeSource '*') $sdkIncludeDir -Recurse -Force

          $readmeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'README.md')
          if (Test-Path $readmeSource) {
            Copy-Item $readmeSource $sdkDir -Force
          }

          $platform = $Env:ARTIFACT_PLATFORM_SUFFIX
          $cliZip = Join-Path $publishDir "licenx-admin-cli-$platform.zip"
          $sdkZip = Join-Path $publishDir "licenx-sdk-$platform.zip"

          if (Test-Path $cliZip) { Remove-Item $cliZip -Force }
          if (Test-Path $sdkZip) { Remove-Item $sdkZip -Force }

          Compress-Archive -Path (Join-Path $cliDir '*') -DestinationPath $cliZip -Force
          Compress-Archive -Path (Join-Path $sdkDir '*') -DestinationPath $sdkZip -Force

          "publish-dir=$publishDir" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: licenx-windows
          path: ${{ steps.package.outputs.publish-dir }}
          if-no-files-found: error

  publish-and-docker:
    name: Publish artifacts & Docker image
    needs:
      - build-linux
      - build-macos
      - build-windows
    runs-on: ubuntu-latest
    env:
      CMAKE_GENERATOR: Ninja
      CMAKE_BUILD_TYPE: Release
      CMAKE_MULTICONFIG: 'false'
      ARTIFACT_PLATFORM_SUFFIX: linux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Prepare LicenX workspace
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $moduleDir = [System.IO.Path]::Combine($Env:GITHUB_WORKSPACE, '.git/modules', $Env:LICENX_SUBMODULE_PATH)
          if (Test-Path $moduleDir) {
            Remove-Item $moduleDir -Recurse -Force
          }
          if (Test-Path $Env:LICENX_SUBMODULE_PATH) {
            Remove-Item $Env:LICENX_SUBMODULE_PATH -Recurse -Force
          }

      - name: Checkout LicenX source
        uses: actions/checkout@v4
        with:
          repository: ergosumx/licenx
          ref: ${{ github.event.inputs.licenx-branch || 'main' }}
          path: ${{ env.LICENX_SUBMODULE_PATH }}
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.ERGOX_SUBMODULE_TOKEN }}

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ninja-build libcurl4-openssl-dev

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Configure LicenX build (container stage)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $cmakeArgs = @(
            '-S', $Env:LICENX_SOURCE_DIR,
            '-B', $Env:LICENX_BUILD_DIR,
            '-G', $Env:CMAKE_GENERATOR,
            "-DLICENX_ENVIRONMENT=$Env:LICENX_ENVIRONMENT_INPUT",
            '-DLICENX_BUILD_TESTS=OFF'
          )
          if ($Env:CMAKE_MULTICONFIG -ne 'true') {
            $cmakeArgs += "-DCMAKE_BUILD_TYPE=$Env:CMAKE_BUILD_TYPE"
          }
          if ($Env:CMAKE_GENERATOR_PLATFORM) {
            $cmakeArgs += '-A'
            $cmakeArgs += $Env:CMAKE_GENERATOR_PLATFORM
          }
          if ($Env:CMAKE_TOOLCHAIN_FILE) {
            $cmakeArgs += "-DCMAKE_TOOLCHAIN_FILE=$Env:CMAKE_TOOLCHAIN_FILE"
          }
          if ($Env:CMAKE_PREFIX_PATH) {
            $cmakeArgs += "-DCMAKE_PREFIX_PATH=$Env:CMAKE_PREFIX_PATH"
          }
          cmake @cmakeArgs

      - name: Build LicenX artifacts (container stage)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $args = @('--build', $Env:LICENX_BUILD_DIR)
          if ($multiConfig) { $args += @('--config', $Env:LICENX_BUILD_CONFIG) }
          cmake @args

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: licenx-windows
          path: collected/windows

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: licenx-linux
          path: collected/linux

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: licenx-macos
          path: collected/macos

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Publish packages to Azure Files
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $source = Join-Path $Env:GITHUB_WORKSPACE 'collected'
          if (-not (Test-Path $source)) {
            throw "Collected artifacts directory $source not found."
          }

          $targets = @(
            @{ Folder = 'windows'; Destination = "$($Env:AZURE_STORAGE_PATH)/windows-x64" },
            @{ Folder = 'linux'; Destination = "$($Env:AZURE_STORAGE_PATH)/linux-x64" },
            @{ Folder = 'macos'; Destination = "$($Env:AZURE_STORAGE_PATH)/macos-universal" }
          )

          foreach ($target in $targets) {
            $platformSource = Join-Path $source $target.Folder
            if (-not (Test-Path $platformSource)) {
              Write-Host "::warning::Platform artifacts not found at $platformSource. Skipping upload to $($target.Destination)."
              continue
            }

            az storage file upload-batch `
              --source $platformSource `
              --account-name $Env:AZURE_STORAGE_ACCOUNT `
              --destination $Env:AZURE_STORAGE_SHARE `
              --destination-path $target.Destination `
              --overwrite `
              --no-progress `
              --auth-mode login
          }

      - name: Build and push LicenX server image
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $dockerfileInput = '${{ github.event.inputs.dockerfile-relative-path || 'ergox/licenx/docker/admin-cli-server/Dockerfile' }}'
          $dockerfile = Join-Path $Env:GITHUB_WORKSPACE $dockerfileInput
          if (-not (Test-Path $dockerfile)) {
            Write-Host "::warning::Dockerfile not found at $dockerfile. Skipping container build."
            return
          }

          $context = Split-Path $dockerfile -Parent
          az acr login --name $Env:ACR_REGISTRY

          $tag = '${{ github.event.inputs.docker-image-tag || 'latest' }}'
          $fullTagLatest = "$Env:ACR_LOGIN_SERVER/$Env:ACR_IMAGE_NAME:latest"
          $fullTagCustom = "$Env:ACR_LOGIN_SERVER/$Env:ACR_IMAGE_NAME:$tag"

          docker build --file $dockerfile --build-arg LICENX_BUILD_DIR=$Env:LICENX_BUILD_DIR --tag $fullTagLatest --tag $fullTagCustom $context
          docker push $fullTagLatest
          if ($tag -ne 'latest') {
            docker push $fullTagCustom
          }
